import 'package:flutter/material.dart';
import 'package:flutter_blue_plus/flutter_blue_plus.dart';

void main() {
  runApp(const MyApp());
}

class MyApp extends StatelessWidget {
  const MyApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'Bluetooth Connect',
      theme: ThemeData(
        colorScheme: ColorScheme.fromSeed(seedColor: Colors.blue),
        useMaterial3: true,
      ),
      home: const BluetoothConnectPage(),
    );
  }
}

class BluetoothConnectPage extends StatefulWidget {
  const BluetoothConnectPage({super.key});

  @override
  State<BluetoothConnectPage> createState() => _BluetoothConnectPageState();
}

class _BluetoothConnectPageState extends State<BluetoothConnectPage> {
  final TextEditingController _macAddressController = TextEditingController();
  String _statusMessage = "Ù„Ø·ÙØ§ Ù…Ú© Ø¢Ø¯Ø±Ø³ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ Ùˆ Ø¯Ú©Ù…Ù‡ Ø§ØªØµØ§Ù„ Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.";

  // Ù…ØªØ¯ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø¯Ø³ØªÚ¯Ø§Ù‡
  Future<void> _connectToDevice() async {
    String macAddress = _macAddressController.text.trim();

    if (macAddress.isEmpty) {
      setState(() {
        _statusMessage = "Ù…Ú© Ø¢Ø¯Ø±Ø³ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø®Ø§Ù„ÛŒ Ø¨Ø§Ø´Ø¯!";
      });
      return;
    }

    setState(() {
      _statusMessage = "Ø¯Ø± Ø­Ø§Ù„ Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªÚ¯Ø§Ù‡...";
    });

    try {
      var subscription = FlutterBluePlus.scanResults.listen((results) async {
        for (ScanResult r in results) {
          print('Ø¯Ø³ØªÚ¯Ø§Ù‡ Ù¾ÛŒØ¯Ø§ Ø´Ø¯: ${r.device.remoteId}');

          if (r.device.remoteId.str.toUpperCase() == macAddress.toUpperCase()) {
            setState(() {
              _statusMessage = "Ø¯Ø³ØªÚ¯Ø§Ù‡ Ù¾ÛŒØ¯Ø§ Ø´Ø¯! Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„...";
            });

            await FlutterBluePlus.stopScan();

            try {
              await r.device.connect();
              setState(() {
                _statusMessage = "Ø§ØªØµØ§Ù„ Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ² Ø¨ÙˆØ¯! ğŸ‰";
              });
            } catch (e) {
              setState(() {
                _statusMessage = "Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„: $e";
              });
            }
            return;
          }
        }
      });

      // Ø´Ø±ÙˆØ¹ Ø§Ø³Ú©Ù†
      await FlutterBluePlus.startScan(timeout: const Duration(seconds: 10));

      // Ù…Ù†ØªØ¸Ø± Ù…ÛŒâ€ŒÙ…Ø§Ù†ÛŒÙ… ØªØ§ Ø§Ø³Ú©Ù† ØªÙ…Ø§Ù… Ø´ÙˆØ¯
      await Future.delayed(const Duration(seconds: 10));

      await FlutterBluePlus.stopScan();
      subscription.cancel();

      setState(() {
        _statusMessage = "Ø¯Ø³ØªÚ¯Ø§Ù‡ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯. Ù„Ø·ÙØ§ Ø¢Ø¯Ø±Ø³ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.";
      });
    } catch (e) {
      setState(() {
        _statusMessage = "Ø®Ø·Ø§ Ø¯Ø± ÙØ±Ø¢ÛŒÙ†Ø¯ Ø§Ø³Ú©Ù†: $e";
      });
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø¨Ù„ÙˆØªÙˆØ«'),
        centerTitle: true,
      ),
      body: Padding(
        padding: const EdgeInsets.all(20.0),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            TextField(
              controller: _macAddressController,
              decoration: const InputDecoration(
                border: OutlineInputBorder(),
                labelText: 'Ù…Ú© Ø¢Ø¯Ø±Ø³ Ø¯Ø³ØªÚ¯Ø§Ù‡',
              ),
            ),
            const SizedBox(height: 20),
            ElevatedButton(
              onPressed: _connectToDevice,
              child: const Text('Ø§ØªØµØ§Ù„'),
            ),
            const SizedBox(height: 30),
            Text(
              _statusMessage,
              textAlign: TextAlign.center,
              style: const TextStyle(fontSize: 16, color: Colors.black87),
            ),
          ],
        ),
      ),
    );
  }
}
